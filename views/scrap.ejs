<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Monitoramento</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
</head>
<body>
    <%- include('partials/navbar') -%>
    <div class="container mt-4">
        <h1 class="mb-4">Realizar Novo Scraping</h1>
        <form id="scrapForm">
            <div class="mb-3" id="cityDiv">
                <label for="city" class="form-label">Cidade</label>
                <input type="text" class="form-control w-50" id="city" name="city" placeholder="Ex: sao-joao-del-rei" required>
            </div>
            <div class="mb-3" id="stateDiv">
                <label for="state" class="form-label">Estado</label>
                <input type="text" class="form-control w-50" id="state" name="state" placeholder="Ex: MG" required>
            </div>
            <div class="mb-3">
                <label for="platform" class="form-label">Plataforma</label>
                <select class="form-select w-50" id="platform" name="platform" required>
                    <option value="aiqfome">Aiqfome</option>
                    <option value="uairango">UaiRango</option>
                    <option value="ifood">iFood</option>
                </select>
            </div>
            <div class="mb-3" id="fileUploadDiv" style="display: none;">
                <label for="ifoodFile" class="form-label">Selecione o arquivo HTML</label>
                <input type="file" class="form-control w-50" id="ifoodFile" name="ifoodFile" accept=".html">
            </div>
            
            <button type="submit" class="btn btn-primary w-25" onclick="startProgress()">Iniciar Scraping</button>
            <a href="/" class="btn btn-warning w-25">Visualizar Lista de Scrapings</a>
        </form>

        <div id="loadingMessage" class="mt-4 alert alert-info w-50" style="display: none;">
            <h4>Processado: <span id="progress">0%</span></h4>
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
        </div>
        <div id="resultMessage" class="mt-4"></div>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.min.js" integrity="sha384-7qAoOXltbVP82dhxHAUje59V5r2YsVfBafyUDxEdApLPmcdhBPg1DKg1ERo0BZlK" crossorigin="anonymous"></script>
<script src="/js/bootstrap.min.js"></script>
<script>
        const form = document.getElementById("scrapForm");
        const loadingDiv = document.getElementById("loadingMessage");
        const resultDiv = document.getElementById("resultMessage");
        const cityDiv = document.getElementById("cityDiv");
        const stateDiv = document.getElementById("stateDiv");
        const fileUploadDiv = document.getElementById("fileUploadDiv");

        platform.addEventListener("change", () => {
            if (platform.value === "ifood") {
                fileUploadDiv.style.display = "block";
                cityDiv.style.display = "none";
                cityDiv.querySelector("input").required = false;
                stateDiv.style.display = "none";
                stateDiv.querySelector("input").required = false;

            } else {
                fileUploadDiv.style.display = "none";
                cityDiv.style.display = "block";
                cityDiv.querySelector("input").required = true;
                stateDiv.style.display = "block";
                stateDiv.querySelector("input").required = true;
            }
        });

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            resultDiv.innerHTML = "";
            loadingDiv.style.display = "block";

            let url = "";
            let options = {};

            if (platform.value === "aiqfome") {
                const city = document.getElementById("city").value;
                const state = document.getElementById("state").value;

                url = "http://localhost:3000/scrapeaiqfome";
                options = {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ city, state })
                };

            } else if (platform.value === "ifood") {
                const fileInput = document.getElementById("ifoodFile");
                if (fileInput.files.length === 0) {
                    resultDiv.innerHTML = `<p class="text-danger">Selecione um arquivo HTML antes de enviar.</p>`;
                    loadingDiv.style.display = "none";
                    return;
                }

                const formData = new FormData();
                formData.append("file", fileInput.files[0]);

                url = "http://localhost:3000/scrapeifood";
                options = {
                    method: "POST",
                    body: formData
                };
            } else if (platform.value === "uairango") {
                const city = document.getElementById("city").value;
                const state = document.getElementById("state").value;

                url = "http://localhost:3000/scrapeuairango";
                options = {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ city, state })
                };
            }

            try {
                const response = await fetch(url, options);
                const data = await response.json();
                resultDiv.innerHTML = `<pre class="alert alert-success w-50">${JSON.stringify(data, null, 2)}</pre>`;
            } catch (err) {
                resultDiv.innerHTML = `<p class="alert alert-danger w-50">Erro: ${err.message}</p>`;
            } finally {
                loadingDiv.style.display = "none";
            }
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js"></script>
    <script>
        let socket = io('http://localhost:3000');

        socket.on('progress', (data) => {
            updateProgress(data.percentage);

            console.log('Progress update: ', data);
            if (data.percentage >= 100) {
                setTimeout(() => {
                    resetProgress();
                }, 2000);
            }
        });

        function startProgress() {
            socket.emit('startProgress');
        }

        function updateProgress(percentage) {
            let progress = document.getElementById('progress');
            let progressBar = document.querySelector('.progress-bar');
            progress.innerText = percentage + '%';
            progressBar.style.width = percentage + '%';
            progressBar.setAttribute('aria-valuenow', percentage);
        }

        function resetProgress() {
            let progress = document.getElementById('progress');
            let progressBar = document.querySelector('.progress-bar');
            progress.innerText = '0%';
            progressBar.style.width = '0%';
            progressBar.setAttribute('aria-valuenow', 0);
        }
    </script>
</html>