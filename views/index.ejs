<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Monitoramento</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
</head>
<body>
    <%- include('partials/navbar') -%>

    <div class="container mt-5">
        <h1 class="mb-4">Monitoramento de Estabelecimentos</h1>

        <% if (error != null) { %>
            <div class="alert alert-danger" role="alert">
                <%= error %>
            </div>
            <a href="/" class="btn btn-primary">Recarregar Página</a>
        <% } else if (scraps.length === 0) { %>
            <div class="alert alert-info" role="alert">
                Nenhum registro de scrap no banco de dados.
            </div>
            <%- include('partials/filter') -%>
        <% } else { %>
            <div class="alert alert-success" role="alert">
                Total de registros: <strong><%= registriesCount %></strong>
            </div>

            <%- include('partials/filter') -%>

            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>Cidade</th>
                        <th>Estado</th>
                        <th>Plataforma</th>
                        <th>Link da Loja</th>
                        <th>Nº de Avaliações</th>
                        <th>Data da Última Avaliação</th>
                        <th>Data do Scrap</th>
                    </tr>
                </thead>
                <tbody>
                    <% scraps.forEach(scrap => { %>
                        <tr>
                            <td><%= scrap.id %></td>
                            <td><%= scrap.establishment %></td>
                            <td><%= scrap.city %></td>
                            <td><%= scrap.state %></td>
                            <td><%= scrap.platform %></td>
                            <td><a href="<%= scrap.link %>" target="_blank">Acessar página</a></td>
                            <td><%= scrap.reviews %></td>
                            <td><%= scrap.last_review ? scrap.last_review.toLocaleDateString() : 'N/A' %></td>
                            <td><%= scrap.createdAt.toLocaleDateString() %></td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>

            <% 
                const queryString = 
                    `&city=${filters.city || ''}` +
                    `&state=${filters.state || ''}` +
                    `&platform=${filters.platform || ''}` +
                    `&date=${filters.date || ''}`;
            %>

            <nav aria-label="Page navigation example">
                <ul class="pagination">
                    <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                    <a class="page-link" href="/page/?page=<%= currentPage > 1 ? currentPage - 1 : 1 %><%= queryString %>" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                        <span class="sr-only">Previous</span>
                    </a>
                    </li>

                    <% for(let i = 1; i <= totalPages; i++) { %>
                    <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                        <a class="page-link" href="/page/?page=<%= i %><%= queryString %>"><%= i %></a>
                    </li>
                    <% } %>

                    <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                    <a class="page-link" href="/page/?page=<%= currentPage < totalPages ? currentPage + 1 : totalPages %><%= queryString %>" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                        <span class="sr-only">Next</span>
                    </a>
                    </li>
                </ul>
            </nav>
        <% } %>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.min.js" integrity="sha384-7qAoOXltbVP82dhxHAUje59V5r2YsVfBafyUDxEdApLPmcdhBPg1DKg1ERo0BZlK" crossorigin="anonymous"></script>
<script src="/js/bootstrap.min.js"></script>
</html>